#!/bin/sh

# Run the test suite before pushing to remote, so the GitLab CI fails less
# often
# This hook is called with the following parameters:
#
# $1 -- Name of the remote to which the push is being done
# $2 -- URL to which the push is being done
#
# If pushing without using a named remote those arguments will be equal.
#
# If the log message starts with "WIP:" (work in progress) the push is allowed
# even if the tests fail, since it might be necessary to push to share between
# work environments.

remote="$1"
url="$2"

status=0
poetry run pytest -n auto tests || status=1
poetry run flake8 duplicate_images tests || status=1
poetry run mypy duplicate_images tests || status=1
poetry run pylint duplicate_images tests || status=1

if [ $status -gt 0 ]; then
  commitmsg=$(git log --oneline | head -n 1 | cut -d' ' -f 2-)
  if echo $commitmsg | grep '^WIP:'; then
    echo >&2 "Found WIP commit, pushing in spite of failed test suite"
    status=0
  fi
fi
echo Status: $status
exit $status
